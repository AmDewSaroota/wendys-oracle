<!--
  EcoStove - Auto-fetch Sensor Button
  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö biomassstove

  ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:
  1. Copy ‡∏™‡πà‡∏ß‡∏ô HTML ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  2. Copy ‡∏™‡πà‡∏ß‡∏ô JavaScript ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô </body>
  3. ‡πÅ‡∏Å‡πâ SUPABASE_URL ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö project
-->

<!-- ===== HTML: ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sensor ===== -->
<div class="sensor-fetch-section p-4 bg-green-50 rounded-lg mb-4">
  <h3 class="text-lg font-bold mb-2">üì° ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sensor</h3>

  <div class="grid grid-cols-2 gap-2 mb-3">
    <div>
      <label class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Device:</label>
      <select id="sensorDeviceSelect" class="w-full p-2 border rounded">
        <option value="a3b9c2e4bdfe69ad7ekytn">MT29 - ‡∏ö‡πâ‡∏≤‡∏ô 1</option>
        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° device ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
      </select>
    </div>
    <div>
      <label class="text-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ï‡∏≤:</label>
      <select id="stoveTypeSelect" class="w-full p-2 border rounded">
        <option value="eco">‡πÄ‡∏ï‡∏≤ Eco</option>
        <option value="traditional">‡πÄ‡∏ï‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°</option>
      </select>
    </div>
  </div>

  <button id="fetchSensorBtn" onclick="fetchFromSensor()"
    class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-bold hover:bg-green-600">
    üì° ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Sensor
  </button>

  <div id="sensorResult" class="mt-3 hidden">
    <div class="bg-white p-3 rounded border">
      <div class="grid grid-cols-3 gap-2 text-center">
        <div>
          <div class="text-2xl font-bold text-blue-600" id="resultPM25">--</div>
          <div class="text-xs">PM2.5</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-orange-600" id="resultCO2">--</div>
          <div class="text-xs">CO2</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-red-600" id="resultTemp">--</div>
          <div class="text-xs">Temp</div>
        </div>
      </div>
      <div class="text-center text-green-600 mt-2" id="resultMessage"></div>
    </div>
  </div>
</div>


<!-- ===== JavaScript: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ===== -->
<script>
// ‡πÅ‡∏Å‡πâ URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Supabase project
const SUPABASE_FUNCTION_URL = 'https://zijybzjstjlqvhmckgor.supabase.co/functions/v1/fetch-sensor';

async function fetchFromSensor() {
  const btn = document.getElementById('fetchSensorBtn');
  const resultDiv = document.getElementById('sensorResult');

  // Get selected values
  const deviceId = document.getElementById('sensorDeviceSelect').value;
  const stoveType = document.getElementById('stoveTypeSelect').value;

  // Show loading
  btn.disabled = true;
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
  resultDiv.classList.add('hidden');

  try {
    const response = await fetch(SUPABASE_FUNCTION_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        device_id: deviceId,
        stove_type: stoveType,
        // volunteer_id: currentVolunteerId, // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ login
        // subject_id: selectedSubjectId,    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡πâ‡∏≤‡∏ô
      }),
    });

    const data = await response.json();

    if (data.success) {
      // Show results
      document.getElementById('resultPM25').textContent = data.readings.pm25 ?? '--';
      document.getElementById('resultCO2').textContent = data.readings.co2 ?? '--';
      document.getElementById('resultTemp').textContent = (data.readings.temperature ?? '--') + '¬∞C';
      document.getElementById('resultMessage').textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (ID: ${data.record_id})`;
      resultDiv.classList.remove('hidden');

      // Refresh data table if exists
      if (typeof loadData === 'function') {
        loadData();
      }
    } else {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || 'Unknown error'));
    }

  } catch (err) {
    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'üì° ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Sensor';
  }
}
</script>
